clear all


%% Dynamics Definition
syms x y vx vy

% Define the potential
V = +1e-1*(x.^2 - y.^2);
% Create the function handle version of the potential
Vfh = matlabFunction(V,'Vars',{x,y});

% Create the State Vector 
StateVector = [x y vx vy].';
% Create the dynamics: \dot{StateVector} = F(t,StateVector,Control)
F = [       vx   ; ...
            vy   ; ...
      -diff(V,x) ; ...
      -diff(V,y) ];
% We create the control - We need this because DyCon Toolbox need a some
% control
syms u
Control = u;
% create de ode structure with the DyCon ToolBox syntax;
dynamics = ode(F,StateVector,Control);
% choose our options 
%dynamics.InitialCondition = [10  0.0  0.0  0.0]'; % [x0 y0 vx0 vy0]
dynamics.InitialCondition = [10  0.001  0.0  0.0]'; % [x0 y0 vx0 vy0]

dynamics.FinalTime        = 50;          % Tend = 50 
dynamics.Nt               = 500;         % Number of Time points   
%% Solve Dynamics
[~,StateSolution] = solve(dynamics);
%% Define mesh 
XLim = [-20 20];
YLim = [-20 20];
%
xline = linspace(XLim(1),XLim(2),50);
yline = linspace(YLim(1),YLim(2),50);
%
[xms ,yms] = meshgrid(xline,yline);
zms = Vfh(xms,yms);
%% Create Graphs Objects
clf
% Create the mesh of shere
[X,Y,Z] = sphere;
radius = 2;
X = X*radius; Y = Y*radius; Z = Z*radius;
% create the sphere object
isurf = surf(X,Y,Z);
% set color of sphere
isurf.CData = isurf.CData*0 + 1;
shading interp
%

hold on 
daspect([1 1 1])

% Create the potential with some FaceAlpha (Transparent)
surf(xms,yms,zms,'FaceAlpha',0.3);

%% Create animation 
AzAngle = -210; 
ElAngle   = 57;

% fixed Limits of Graphs
isurf.Parent.XLim = XLim;
isurf.Parent.YLim = YLim;
isurf.Parent.ZLim = isurf.Parent.ZLim;

lightangle(165,73)

gif('animation.gif')
for it = 1:dynamics.Nt
    % change the sphere position
    isurf.XData = X + StateSolution(it,1);
    isurf.YData = Y + StateSolution(it,2);
    isurf.ZData = Z + Vfh(StateSolution(it,1),StateSolution(it,2)) + 2*radius;
    % change the Azimutal Angle in 0.1 degree
    AzAngle = AzAngle + 0.1;
    view(isurf.Parent,AzAngle,ElAngle)
    % pause for see the update graphs 
    pause(0.01)
    % get frame
    gif('frame',isurf.Parent.Parent)
    % stop animation when the potential is very high
    if abs(Vfh(StateSolution(it,1),StateSolution(it,2))) > 200
        break
    end
end
